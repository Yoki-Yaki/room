<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>...</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>💻</text></svg>">
    <style>
        body {
            margin: 0;
            background: black;
            color: white;
            font: 16px/1.5 system-ui, sans-serif;
            letter-spacing: .02em;
            cursor: pointer;
        }

        .wrap {
            padding: 1rem;
        }

        .line {
            margin: 0;
        }

        .cursor {
            display: inline-block;
            animation: blink 1s steps(1) infinite;
        }

        @keyframes blink {
            50% {
                opacity: 0;
            }
        }

        .hint {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 18px;
            opacity: 0.7;
        }
    </style>
</head>
<body>
    <div class="wrap" id="wrap"></div>
    <div id="hint" class="hint">Click to join...</div>

    <script>
        (function () {
            const wrap = document.getElementById('wrap');
            const hint = document.getElementById('hint');
            const params = new URLSearchParams(location.search);

            const defaults = {
                lines: [
                    "Attempting to connect to the R.O.O.M. ...",
                    "Failed...",
                    "",
                    "Attempting to obtain coordinates of the R.O.O.M. ...",
                    "Failed...",
                    "",
                    "Attempting to obtain last data from the R.O.O.M. ...",
                    "Successful!",
                    " ",
                    "Decoding...",
                    "Successful!",
                    "Downloading..."
                ],
                speed: 60,
                startDelay: 500,
                lineDelay: 1000,
                loop: false,
                sound: "sounds/uifont.wav",
                downloadFile: "sprites/iceb.png" // file to download after typing
            };

            const cfg = {
                lines: (params.get('text')?.split("\\n")) ?? defaults.lines,
                speed: Number(params.get('speed') ?? defaults.speed),
                startDelay: Number(params.get('startDelay') ?? defaults.startDelay),
                lineDelay: Number(params.get('lineDelay') ?? defaults.lineDelay),
                loop: (params.get('loop') ?? String(defaults.loop)) === 'true',
                sound: params.get('sound') ?? defaults.sound,
                downloadFile: params.get('download') ?? defaults.downloadFile
            };

            const escapeHTML = (s) => s
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;');

            const sleep = (ms) => new Promise(r => setTimeout(r, ms));

            function playSound() {
                if (!cfg.sound) return;
                const audio = new Audio(cfg.sound);
                audio.volume = 0.5;
                audio.play().catch(() => { });
            }

            async function typeLine(text) {
                return new Promise(async (resolve) => {
                    const p = document.createElement("div");
                    p.className = "line";
                    wrap.appendChild(p);

                    const span = document.createElement("span");
                    const cursor = document.createElement("span");
                    cursor.className = "cursor";
                    cursor.textContent = "_";

                    p.appendChild(span);
                    p.appendChild(cursor);

                    const chars = [...text];
                    for (let i = 0; i < chars.length; i++) {
                        span.innerHTML += escapeHTML(chars[i]);
                        playSound();
                        await sleep(cfg.speed);
                    }

                    cursor.remove();
                    resolve();
                });
            }

            async function run() {
                wrap.innerHTML = "";
                await sleep(cfg.startDelay);

                for (let line of cfg.lines) {
                    await typeLine(line);
                    await sleep(cfg.lineDelay);
                }

                if (cfg.loop) {
                    await sleep(cfg.lineDelay);
                    run();
                } else {
                    // Trigger file download once typing is complete
                    if (cfg.downloadFile) {
                        const link = document.createElement("a");
                        link.href = cfg.downloadFile;
                        link.download = cfg.downloadFile.split("/").pop();
                        document.body.appendChild(link);
                        link.click();
                        link.remove();
                    }
                }
            }

            // Wait for first click
            function startTyping() {
                hint.remove();
                document.removeEventListener('click', startTyping);
                run();
            }

            document.addEventListener('click', startTyping);
        })();
    </script>
</body>
</html>

